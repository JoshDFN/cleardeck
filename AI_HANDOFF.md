# ClearDeck - AI Development Handoff

> **This document is for AI assistants (Claude, etc.) continuing development on this project.**

## Quick Context

ClearDeck is a **fully on-chain poker application** on the Internet Computer. It supports:
- Real ICP and Bitcoin (via ckBTC) for stakes
- Provably fair shuffles using IC's VRF
- Internet Identity authentication
- Multiple table formats and stake levels

**100% of this code was generated by Claude (AI).**

---

## Live Deployment

| Canister | ID | Purpose |
|----------|-----|---------|
| Frontend | `kbhpl-riaaa-aaaaj-qor2a-cai` | SvelteKit app |
| Lobby | `kpfcd-kyaaa-aaaaj-qor3a-cai` | Table discovery |
| History | `kggj7-4qaaa-aaaaj-qor2q-cai` | Hand records |
| Table 1 | `kieex-haaaa-aaaaj-qor3q-cai` | Heads-up 0.01/0.02 ICP |
| Table 2 | `lfkaz-iiaaa-aaaaj-qor4a-cai` | 6-max 0.05/0.10 ICP |
| Table 3 | `lclgn-fqaaa-aaaaj-qor4q-cai` | 9-max 0.10/0.20 ICP |
| BTC Table | `qrhly-eaaaa-aaaaj-qousa-cai` | Heads-up 100/200 sats |

**Live URL:** https://kbhpl-riaaa-aaaaj-qor2a-cai.icp0.io/

---

## Project Structure

```
cleardeck/
├── src/
│   ├── lobby_canister/              # Rust - table registry
│   │   ├── src/lib.rs               # ~200 lines
│   │   └── lobby_canister.did
│   ├── table_canister/              # Rust - poker engine
│   │   ├── src/lib.rs               # ~4500 lines (core logic)
│   │   └── table_canister.did       # Candid interface
│   ├── history_canister/            # Rust - permanent storage
│   │   ├── src/lib.rs               # ~400 lines
│   │   └── history_canister.did
│   └── cleardeck_frontend/          # SvelteKit 5
│       ├── src/
│       │   ├── routes/+page.svelte  # ~1600 lines (main app)
│       │   └── lib/
│       │       ├── auth.js          # Internet Identity
│       │       ├── canisters.js     # Actor creation
│       │       └── components/
│       │           ├── PokerTable.svelte    # ~2100 lines
│       │           ├── Lobby.svelte         # ~1100 lines
│       │           ├── DepositModal.svelte  # ~1500 lines
│       │           ├── WithdrawModal.svelte
│       │           ├── WalletButton.svelte
│       │           ├── HandHistory.svelte
│       │           └── ShuffleProof.svelte
│       └── package.json
├── dfx.json                         # Canister config & init args
├── Cargo.toml                       # Rust workspace
└── Dockerfile                       # Reproducible builds
```

---

## Key Technical Concepts

### Currency Handling

**ICP:**
- 1 ICP = 100,000,000 e8s (8 decimal places)
- All backend values in e8s
- Frontend converts for display
- Ledger: `ryjl3-tyaaa-aaaaa-aaaba-cai`

**ckBTC:**
- 1 BTC = 100,000,000 satoshis
- Uses ckBTC (chain-key Bitcoin)
- Ledger: `mxzaz-hqaaa-aaaar-qaada-cai`
- Minter: `mqygn-kiaaa-aaaar-qaadq-cai`

### Deposit Flow (ICRC-2)

```
1. User calls icrc2_approve on ledger (authorize table canister)
2. User calls deposit(amount) on table canister
3. Table canister calls icrc2_transfer_from to pull funds
4. Escrow balance credited
```

### BTC Deposit Flow

```
1. User calls get_btc_deposit_address() → unique BTC address
2. User sends real BTC to that address
3. After 6 confirmations, user calls update_btc_balance()
4. ckBTC minter mints ckBTC 1:1
5. User deposits ckBTC to table (same as ICP flow)
```

### Shuffle Algorithm (Provably Fair)

```rust
// Commit phase (before dealing)
let seed = ic_cdk::api::management_canister::main::raw_rand().await;
let seed_hash = sha256(&seed);
// Store seed_hash publicly

// Shuffle with Fisher-Yates
fn shuffle_deck(deck: &mut Vec<Card>, seed: &[u8]) {
    let mut hash_input = seed.to_vec();
    for i in (1..deck.len()).rev() {
        let hash = sha256_with_index(&hash_input, i);
        let j = u64_from_bytes(&hash) % (i + 1);
        deck.swap(i, j);
        hash_input = hash;
    }
}

// Reveal phase (after hand)
// Store full seed in history canister
// Anyone can verify: sha256(seed) == seed_hash
```

---

## Table Configuration (dfx.json)

```json
"table_1": {
  "init_arg": "(record {
    small_blind = 1000000 : nat64;      // 0.01 ICP
    big_blind = 2000000 : nat64;        // 0.02 ICP
    min_buy_in = 200000000 : nat64;     // 2 ICP (100 BB)
    max_buy_in = 1000000000 : nat64;    // 10 ICP (500 BB)
    max_players = 2 : nat8;             // Heads-up
    action_timeout_secs = 30 : nat64;
    time_bank_secs = 30 : nat64;
    ante = 0 : nat64;
    currency = variant { ICP }
  })"
}
```

For BTC tables, use `currency = variant { BTC }` and satoshi values.

---

## Key Canister Functions

### Table Canister

```candid
// Escrow
deposit : (nat64) -> (Result_1);              // Deposit from wallet
withdraw : (nat64) -> (Result_1);             // Withdraw to wallet
get_balance : () -> (Result_1) query;         // Check escrow

// Game
join_table : (seat: nat8) -> (Result);        // Take a seat
buy_in : (seat: nat8, amount: nat64) -> (Result); // Buy chips
leave_table : () -> (Result_1);               // Leave (chips→escrow)
cash_out : () -> (Result_1);                  // Leave + withdraw

// Actions
player_action : (PlayerAction) -> (Result);
  // Fold | Check | Call | Raise(nat64) | AllIn

// State
get_table_view : () -> (opt TableView) query; // Player's view
get_public_state : () -> (PublicTableState) query;

// BTC-specific
get_btc_deposit_address : () -> (variant { Ok : text; Err : text });
update_btc_balance : () -> (variant { Ok : vec UtxoStatus; Err : text });

// Admin
admin_update_config : (TableConfig) -> (Result_5);
admin_get_all_balances : () -> (...) query;
```

### Lobby Canister

```candid
get_tables : () -> (vec TableInfo) query;
register_table : (principal, TableInfo) -> (Result);
```

### History Canister

```candid
get_hand : (hand_id: nat64) -> (opt HandHistoryRecord) query;
get_hands_by_player : (principal, offset, limit) -> (vec HandSummary) query;
verify_hand_shuffle : (hand_id: nat64) -> (Result<bool, text>);
```

---

## Common Development Commands

```bash
# Build frontend
npm run build

# Deploy to mainnet
export DFX_WARNING=-mainnet_plaintext_identity
dfx deploy frontend --network ic

# Deploy specific canister
dfx deploy table_1 --network ic

# Check table state
dfx canister call table_1 get_public_state --network ic

# Check player balances
dfx canister call table_1 admin_get_all_balances --network ic

# Update table config
dfx canister call table_1 admin_update_config '(record { ... })' --network ic

# Hot reload frontend
cd src/cleardeck_frontend && npm run dev
```

---

## Frontend State Management (Svelte 5)

The app uses Svelte 5's new `$state()` runes:

```svelte
<script>
  let view = $state('lobby');  // 'lobby' | 'table'
  let tableState = $state(null);
  let myBalance = $state(0n);

  // Note: tableActor is NOT $state because Svelte's proxy breaks IC actors
  let tableActor = null;

  // Derived values
  const isMyTurn = $derived(
    tableState?.current_player_seat === mySeat
  );
</script>
```

### Polling Pattern

```javascript
// Poll table state every 2 seconds
$effect(() => {
  if (view === 'table' && tableActor) {
    const interval = setInterval(loadTableState, 2000);
    return () => clearInterval(interval);
  }
});
```

---

## Known Issues

1. **Svelte warnings**: Several "state_referenced_locally" warnings (non-breaking)
2. **Unused CSS**: Some CSS selectors flagged as unused (cleanup TODO)
3. **BTC confirmations**: 6-block wait (~1 hour) for deposits
4. **Hand history**: Can be lost during canister upgrades

---

## Architecture Decisions

1. **Separate table canisters**: Each table is its own canister for isolation and horizontal scaling
2. **Escrow model**: Players deposit to escrow, then buy in - prevents rug pulls
3. **History canister**: Separate from tables for permanent records
4. **Polling vs WebSockets**: IC doesn't support WebSockets, so we poll every 2s
5. **ICRC-2 over ICRC-1**: Approve+transfer_from pattern for better UX

---

## Extending the Project

### Adding a New Table Type

1. Add config in `dfx.json`:
```json
"table_4": {
  "candid": "src/table_canister/table_canister.did",
  "package": "table_canister",
  "type": "rust",
  "init_arg": "(record { ... })"
}
```

2. Register in lobby after deploy:
```bash
dfx canister call lobby register_table '(principal "<id>", record { ... })'
```

### Adding New Game Features

The table canister's `lib.rs` contains all game logic:
- `process_action()` - handles player actions
- `advance_street()` - deals community cards
- `evaluate_hands()` - determines winners
- `distribute_pot()` - handles side pots

### Frontend Components

- `PokerTable.svelte` - game UI, cards, betting
- `Lobby.svelte` - table list (grid/list views)
- `DepositModal.svelte` - ICP/BTC deposits
- `HandHistory.svelte` - past hands with verification

---

## Deployment Checklist

- [ ] Build frontend: `npm run build`
- [ ] Deploy: `dfx deploy frontend --network ic`
- [ ] Check cycles: `dfx canister status <id> --network ic`
- [ ] Test authentication
- [ ] Test deposit/withdraw flow
- [ ] Monitor for errors

---

## Resources

- **IC Docs**: https://internetcomputer.org/docs
- **ckBTC**: https://internetcomputer.org/ckbtc
- **ICRC Standards**: https://github.com/dfinity/ICRC
- **Candid**: https://internetcomputer.org/docs/current/developer-docs/backend/candid

---

**Continue building!** Ask Claude to add features, fix bugs, or extend the platform. All code is AI-friendly.
